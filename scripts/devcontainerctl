#!/bin/bash

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

VSCODE_TAG="${2:-vscode-$(code --version | sed -n '2p' | cut -c1-7)}"
CONTAINERS="devcontainer"

show_usage() {
    echo "Combined script to start or stop the devcontainer"
    echo "Usage: devcontainerctl [start | stop | restart | remove | shell | status | sync] VSCODE_TAG"
}

get_latest_devcontainer() {
   local rc="${1:-false}"
    
        # print a message after 30 seconds if the pull is still ongoing
    (
        sleep 10
        echo -e "\n${YELLOW}Updates can take some time, please be patient...${NC}\n"
    ) &
    background_pid=$!
    trap "kill $background_pid 2>/dev/null" EXIT

    # Always attempt to install the aligned devcontainer
    echo "Checking for devcontainer updates..."
    if [ "$rc" = "true" ]; then
        ces-pull sdf-build-git $GITHUB_TOKEN ghcr.io/smartdatafoundry/devcontainer:$VSCODE_TAG \
            | sed "s/$GITHUB_TOKEN/********/g"
        podman tag ghcr.io/smartdatafoundry/devcontainer:$VSCODE_TAG \
            ghcr.io/smartdatafoundry/devcontainer:latest
    else
        ces-pull a a ghcr.io/smartdatafoundry/devcontainer:$VSCODE_TAG
        podman tag ghcr.io/smartdatafoundry/devcontainer:$VSCODE_TAG \
            ghcr.io/smartdatafoundry/devcontainer:latest
    fi
}

start() {
    echo "Starting devcontainer..."
    
    get_latest_devcontainer
    
    # Stop and remove any existing containers with these names
    podman stop $CONTAINERS 2>/dev/null
    podman rm $CONTAINERS 2>/dev/null
    
    # Start devcontainer
    podman run -d \
        --name devcontainer \
        --restart unless-stopped \
        -e http_proxy \
        -v /safedata:/safedata \
        -v $HOME:$HOME \
        -w $HOME \
        ghcr.io/smartdatafoundry/devcontainer:$VSCODE_TAG sleep infinity
    
    echo "devcontainer service started. Check status with '$0 status'"
}

stop() {
    echo "Stopping devcontainer service..."
    podman stop $CONTAINERS 2>/dev/null
    echo "devcontainer stopped."
}

restart() {
    echo "Restarting devcontainer service..."
    podman stop $CONTAINERS 2>/dev/null
    podman start $CONTAINERS 2>/dev/null
    echo "devcontainer restarted."
}

remove() {
    echo "Stopping and removing devcontainer service..."
    podman stop $CONTAINERS 2>/dev/null
    podman rm $CONTAINERS 2>/dev/null
    echo "devcontainer stopped and removed."
}

show_status() {
    echo "devcontainer Service Status:"
    echo "==========================="
    for container in $CONTAINERS; do
        status=$(podman ps -a --filter "name=$container" --format "{{.Status}}" 2>/dev/null)
        if [ -n "$status" ]; then
            echo "$container: $status"
        else
            echo "$container: Not found"
        fi
    done
}

update() {
    echo "Updating devcontainer image..."
    remove
    start # Restarts the container with the updated image automatically
    echo "devcontainer replaced with updated image."
}

# Main script logic
case "${1:-}" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        stop
        start
        ;;
    status)
        show_status
        ;;
    remove)
        remove
        ;;
    sync)
        get_latest_devcontainer
        ;;
    update)
        update
        ;;
    *)
        show_usage
        exit 1
        ;;
esac
